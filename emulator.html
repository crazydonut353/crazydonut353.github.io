<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChudCPU Emulator</title>
<style>
  body {
    font-family: "Fira Code", monospace;
    background-color: #1e1e2f;
    color: #e0e0e0;
    padding: 20px;
  }
  h1 {
    color: #73d7ff;
  }
  .container {
    display: flex;
    gap: 20px;
  }
  .panel {
    background-color: #2b2b3c;
    padding: 15px;
    border-radius: 8px;
    flex: 1;
    position: relative;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #444;
    padding: 6px;
    text-align: center;
  }
  tr.active {
    background-color: #394b70;
  }
  input.rom-input {
    width: 100%;
    background: transparent;
    color: #c0ffa0;
    border: none;
    text-align: center;
  }
  input.rom-input:focus {
    outline: none;
    background-color: #333a4f;
  }
  button {
    background-color: #444c68;
    border: none;
    color: white;
    padding: 6px 10px;
    margin-right: 5px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }
  button:hover {
    background-color: #5b6ba1;
  }
  /* Pager buttons */
  .pager {
    position: absolute;
    top: 10px;
    right: 10px;
  }

  /* Right-side vertical split */
  .right-panel {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .subpanel {
    background-color: #35354a;
    padding: 10px;
    border-radius: 6px;
  }

  canvas {
    background-color: #111;
    border: 1px solid #555;
    display: block;
    margin: 10px auto;
  }
</style>
</head>
<body>

<h1>ðŸ§  ChudCPU Emulator</h1>

<div class="container">
  <div class="panel">
    <h2>ROM (Program Memory)</h2>
    <div class="pager">
      <button id="prevPage">â—€</button>
      <span id="pageIndicator">Page 0</span>
      <button id="nextPage">â–¶</button>
    </div>
    <table id="romTable">
      <thead>
        <tr><th>Address</th><th>Instruction (hex)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel right-panel">
    <div class="subpanel">
      <h2>CPU State</h2>
      <p><b>Register A:</b> <span id="regA">0</span></p>
      <p><b>Register D:</b> <span id="regD">0</span></p>
      <p><b>Memory[A]:</b> <span id="memA">0</span></p>
      <p><b>Program Counter:</b> <span id="pc">0</span></p>

      <button id="next">Next Instruction</button>
      <button id="reset">Reset</button>
    </div>

    <div class="subpanel">
      <h2>Digital Peripherals</h2>
      <canvas id="display" width="64" height="64"></canvas>
      <div style="text-align:center;">
        <button id="btn1">Button 1</button>
        <button id="btn2">Button 2</button>
      </div>
    </div>
  </div>
</div>

<script>
// bit extraction helper
function extractBits(number, position, length) {
  return (number >>> position) & ((1 << length) - 1);
}

class Counter {
  constructor() { this.register = new Int16Array(1); }
  update(st, X) { this.register[0] = st ? X : this.register[0] + 1; }
  f_reg() { return this.register[0]; }
}

class CM {
  constructor() {
    this.memory = new Int16Array(256);
    this.registers = new Int16Array(2);
  }
  update(regs, X) {
    if (extractBits(regs, 2, 1)) this.memory[this.registers[0]] = X;
    if (extractBits(regs, 0, 1)) this.registers[0] = X;
    if (extractBits(regs, 1, 1)) this.registers[1] = X;
  }
  f_regs() {
    return new Int16Array([
      this.registers[0],
      this.registers[1],
      this.memory[this.registers[0]]
    ]);
  }
}

class ROM {
  constructor() { this.memory = new Int16Array(256); }
  s_mem(ad, X) { this.memory[ad] = X; }
  f_reg(ad) { return this.memory[ad]; }
}

function LU(op, X, Y) {
  return [X & Y, X | Y, X ^ Y, ~X][op];
}

function AU(op, X, Y) {
  if (op == 0) return X + Y;
  if (op == 1) return ~(~X + Y);
  if (op == 2) return X + 1;
  if (op == 3) return X - 1;
}

function ALU(u, op, zx, sw, X, Y) {
  let nx = sw ? Y : X;
  let ny = sw ? X : Y;
  if (zx) nx = 0;
  return u ? AU(op, nx, ny) : LU(op, nx, ny);
}

function COND(lt, eq, gt, X) {
  return ((lt & (X < 0)) | (eq & (X == 0)) | (gt & (X > 0)));
}

function ALU_I(I, A, D, AR) {
  const useAreg = extractBits(I, 12, 1);
  const out = ALU(
    extractBits(I, 10, 1),
    extractBits(I, 8, 2),
    extractBits(I, 7, 1),
    extractBits(I, 6, 1),
    D,
    useAreg ? AR : A
  );
  return new Int16Array([
    out,
    extractBits(I, 3, 3),
    COND(extractBits(I, 2, 1), extractBits(I, 1, 1), extractBits(I, 0, 1), out)
  ]);
}

function CPU(I, A, D, AR) {
  if (extractBits(I, 15, 1)) return ALU_I(I, A, D, AR);
  return [I, 0x64, 0];
}

function COMPUTER(cm, rom, pc) {
  const G = cm.f_regs();
  const instruction = rom.f_reg(pc.f_reg());
  const R = CPU(instruction, G[0], G[1], G[2]);
  cm.update(R[1], R[0]);
  pc.update(R[2], G[0]);

  // If bit 14 is set, update display pixel
  if (extractBits(instruction, 14, 1)) {
    drawPixel(G[0] % 8, G[1] % 8);
  }
}

// === UI ===
const rom = new ROM();
const cm = new CM();
const pc = new Counter();

const romTable = document.querySelector("#romTable tbody");
const regAEl = document.getElementById("regA");
const regDEl = document.getElementById("regD");
const memAEl = document.getElementById("memA");
const pcEl = document.getElementById("pc");

let romPage = 0;
const pageSize = 16;

function renderROM() {
  romTable.innerHTML = "";
  const start = romPage * pageSize;
  const end = start + pageSize;

  for (let i = start; i < end; i++) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i}</td>
      <td><input class="rom-input" data-addr="${i}" value="${rom.memory[i].toString(16)}" /></td>
    `;
    romTable.appendChild(tr);
  }

  document.getElementById("pageIndicator").textContent = `Page ${romPage}`;
}

function refreshUI() {
  const regs = cm.f_regs();
  regAEl.textContent = regs[0];
  regDEl.textContent = regs[1];
  memAEl.textContent = regs[2];
  pcEl.textContent = pc.f_reg();

  [...romTable.children].forEach(tr => tr.classList.remove("active"));
  const currentRow = romTable.children[pc.f_reg() % pageSize];
  if (currentRow) currentRow.classList.add("active");
}

romTable.addEventListener("input", e => {
  if (e.target.classList.contains("rom-input")) {
    const addr = parseInt(e.target.dataset.addr);
    const val = parseInt(e.target.value, 16);
    rom.s_mem(addr, val || 0);
  }
});

document.getElementById("next").addEventListener("click", () => {
  COMPUTER(cm, rom, pc);
  refreshUI();
});

document.getElementById("reset").addEventListener("click", () => {
  pc.register[0] = 0;
  cm.registers[0] = 0;
  cm.registers[1] = 0;
  refreshUI();
});

document.getElementById("nextPage").addEventListener("click", () => {
  romPage = (romPage + 1) % (256 / pageSize);
  renderROM();
  refreshUI();
});

document.getElementById("prevPage").addEventListener("click", () => {
  romPage = (romPage - 1 + (256 / pageSize)) % (256 / pageSize);
  renderROM();
  refreshUI();
});

// === Digital Peripherals ===
const canvas = document.getElementById("display");
const ctx = canvas.getContext("2d");
ctx.fillStyle = "#000";
ctx.fillRect(0, 0, canvas.width, canvas.height);

function drawPixel(x, y) {
  const size = 8;
  ctx.fillStyle = "#73d7ff";
  ctx.fillRect(x * size, y * size, size, size);
}

document.getElementById("btn1").addEventListener("click", () => {
  alert("Peripheral Button 1 Pressed!");
});

document.getElementById("btn2").addEventListener("click", () => {
  alert("Peripheral Button 2 Pressed!");
});

renderROM();
refreshUI();
</script>

</body>
</html>
